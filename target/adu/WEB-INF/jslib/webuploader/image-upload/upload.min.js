!function(a){a(function(){function t(b){var d=a('<li id="'+b.id+'">'+'<p class="title">'+b.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),e=a('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(d),f=d.find("p.progress span"),g=d.find("p.imgWrap"),h=a('<p class="error"></p>'),i=function(a){switch(a){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}h.text(text).appendTo(d)};"invalid"===b.getStatus()?i(b.statusText):(g.text("预览中"),s.makeThumb(b,function(b,c){var d;return b?(g.text("不能预览"),void 0):(p?(d=a('<img src="'+c+'">'),g.empty().append(d)):a.ajax("../../server/preview.php",{method:"POST",data:c,dataType:"json"}).done(function(b){b.result?(d=a('<img src="'+b.result+'">'),g.empty().append(d)):g.text("预览出错")}),void 0)},l,m),o[b.id]=[b.size,0],b.rotation=0),b.on("statuschange",function(a,c){"progress"===c?f.hide().width(0):"queued"===c&&(d.off("mouseenter mouseleave"),e.remove()),"error"===a||"invalid"===a?(console.log(b.statusText),i(b.statusText),o[b.id][1]=1):"interrupt"===a?i("interrupt"):"queued"===a?o[b.id][1]=0:"progress"===a?(h.remove(),f.css("display","block")):"complete"===a&&d.append('<span class="success"></span>'),d.removeClass("state-"+c).addClass("state-"+a)}),d.on("mouseenter",function(){e.stop().animate({height:30})}),d.on("mouseleave",function(){e.stop().animate({height:0})}),e.on("click","span",function(){var d,c=a(this).index();switch(c){case 0:return s.removeFile(b),void 0;case 1:b.rotation+=90;break;case 2:b.rotation-=90}r?(d="rotate("+b.rotation+"deg)",g.css({"-webkit-transform":d,"-mos-transform":d,"-o-transform":d,transform:d})):g.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(b.rotation/90%4+4)%4+")")}),d.appendTo(c)}function u(b){var c=a("#"+b.id);delete o[b.id],v(),c.off().find(".file-panel").off().end().remove()}function v(){var e,b=0,c=0,d=h.children();a.each(o,function(a,d){c+=d[0],b+=d[0]*d[1]}),e=c?b/c:0,d.eq(0).text(Math.round(100*e)+"%"),d.eq(1).css("width",Math.round(100*e)+"%"),w()}function w(){var b,a="";"ready"===n?a="选中"+i+"个文件，共"+WebUploader.formatSize(j)+"。":"confirm"===n?(b=s.getStats(),b.uploadFailNum&&(a="已成功上传"+b.successNum+"个文件至XX文件夹，"+b.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>')):(b=s.getStats(),a="共"+i+"张（"+WebUploader.formatSize(j)+"），已上传"+b.successNum+"张",b.uploadFailNum&&(a+="，失败"+b.uploadFailNum+"张")),e.html(a)}function x(b){var i;if(b!==n){switch(f.removeClass("state-"+n),f.addClass("state-"+b),n=b){case"pedding":g.removeClass("element-invisible"),c.hide(),d.addClass("element-invisible"),s.refresh();break;case"ready":g.addClass("element-invisible"),a("#filePicker2").removeClass("element-invisible"),c.show(),d.removeClass("element-invisible"),s.refresh();break;case"uploading":a("#filePicker2").addClass("element-invisible"),h.show(),f.text("暂停上传");break;case"paused":h.show(),f.text("继续上传");break;case"confirm":if(h.hide(),a("#filePicker2").removeClass("element-invisible"),f.text("开始上传"),i=s.getStats(),i.successNum&&!i.uploadFailNum)return x("finish"),void 0;break;case"finish":i=s.getStats(),i.successNum?alert("上传成功"):(n="done",location.reload())}w()}}var s,b=a("#uploader"),c=a('<ul class="filelist"></ul>').appendTo(b.find(".queueList")),d=b.find(".statusBar"),e=d.find(".info"),f=b.find(".uploadBtn"),g=b.find(".placeholder"),h=d.find(".progress").hide(),i=0,j=0,k=window.devicePixelRatio||1,l=110*k,m=110*k,n="pedding",o={},p=function(){var a=new Image,b=!0;return a.onload=a.onerror=function(){(1!=this.width||1!=this.height)&&(b=!1)},a.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",b}(),q=function(){var a;try{a=navigator.plugins["Shockwave Flash"],a=a.description}catch(b){try{a=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(c){a="0.0"}}return a=a.match(/\d+/g),parseFloat(a[0]+"."+a[1],10)}(),r=function(){var a=document.createElement("p").style,b="transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a;return a=null,b}();return!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie?(q?function(a){var b,c;window["expressinstallcallback"]=function(a){switch(a){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window["expressinstallcallback"]},b="./expressInstall.swf",c='<object type="application/x-shockwave-flash" data="'+b+'" ',WebUploader.browser.ie&&(c+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),c+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+b+'" />'+'<param name="wmode" value="transparent" />'+'<param name="allowscriptaccess" value="always" />'+"</object>",a.html(c)}(b):b.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>'),void 0):WebUploader.Uploader.support()?(s=WebUploader.create({pick:{id:"#filePicker",label:"点击选择文件"},formData:{uid:123},dnd:"#dndArea",paste:"#uploader",swf:"jslib/webuploader/Uploader.swf",chunked:!1,chunkSize:524288,server:"comm/attachment/uploader",disableGlobalDnd:!0,fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800}),s.on("dndAccept",function(a){for(var b=!1,c=a.length,d=0,e="text/plain;application/javascript ";c>d;d++)if(~e.indexOf(a[d].type)){b=!0;break}return!b}),s.addButton({id:"#filePicker2",label:"继续添加"}),s.on("ready",function(){window.uploader=s}),s.onUploadProgress=function(b,c){var d=a("#"+b.id),e=d.find(".progress span");e.css("width",100*c+"%"),o[b.id][1]=c,v()},s.onFileQueued=function(a){i++,j+=a.size,1===i&&(g.addClass("element-invisible"),d.show()),t(a),x("ready"),v()},s.onFileDequeued=function(a){i--,j-=a.size,i||x("pedding"),u(a),v()},s.on("uploadSuccess",function(){}),s.on("all",function(a){switch(a){case"uploadFinished":x("confirm"),parent.onUploadFinished&&parent.onUploadFinished();break;case"startUpload":x("uploading");break;case"stopUpload":x("paused")}}),s.onError=function(a){alert("Eroor: "+a)},f.on("click",function(){return a(this).hasClass("disabled")?!1:("ready"===n?s.upload():"paused"===n?s.upload():"uploading"===n&&s.stop(),void 0)}),e.on("click",".retry",function(){s.retry()}),e.on("click",".ignore",function(){alert("todo")}),f.addClass("state-"+n),v(),void 0):(alert("Web Uploader 不支持您的浏览器！"),void 0)})}(jQuery);