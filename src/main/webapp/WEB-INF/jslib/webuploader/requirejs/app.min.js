requirejs.config({baseUrl:"../../dist",paths:{jquery:"../examples/image-upload/jquery"}}),require(["webuploader.flashonly"],function(a){$(function(){function r(a){var b=$('<li id="'+a.id+'">'+'<p class="title">'+a.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),d=$('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(b),e=b.find("p.progress span"),f=b.find("p.imgWrap"),g=$('<p class="error"></p>'),h=function(a){switch(a){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}g.text(text).appendTo(b)};"invalid"===a.getStatus()?h(a.statusText):(f.text("预览中"),q.makeThumb(a,function(a,b){if(a)return f.text("不能预览"),void 0;var c=$('<img src="'+b+'">');f.empty().append(c)},l,m),o[a.id]=[a.size,0],a.rotation=0),a.on("statuschange",function(c,f){"progress"===f?e.hide().width(0):"queued"===f&&(b.off("mouseenter mouseleave"),d.remove()),"error"===c||"invalid"===c?(console.log(a.statusText),h(a.statusText),o[a.id][1]=1):"interrupt"===c?h("interrupt"):"queued"===c?o[a.id][1]=0:"progress"===c?(g.remove(),e.css("display","block")):"complete"===c&&b.append('<span class="success"></span>'),b.removeClass("state-"+f).addClass("state-"+c)}),b.on("mouseenter",function(){d.stop().animate({height:30})}),b.on("mouseleave",function(){d.stop().animate({height:0})}),d.on("click","span",function(){var c,b=$(this).index();switch(b){case 0:return q.removeFile(a),void 0;case 1:a.rotation+=90;break;case 2:a.rotation-=90}p?(c="rotate("+a.rotation+"deg)",f.css({"-webkit-transform":c,"-mos-transform":c,"-o-transform":c,transform:c})):f.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(a.rotation/90%4+4)%4+")")}),b.appendTo(c)}function s(a){var b=$("#"+a.id);delete o[a.id],t(),b.off().find(".file-panel").off().end().remove()}function t(){var d,a=0,b=0,c=h.children();$.each(o,function(c,d){b+=d[0],a+=d[0]*d[1]}),d=b?a/b:0,c.eq(0).text(Math.round(100*d)+"%"),c.eq(1).css("width",Math.round(100*d)+"%"),u()}function u(){var c,b="";"ready"===n?b="选中"+i+"张图片，共"+a.formatSize(j)+"。":"confirm"===n?(c=q.getStats(),c.uploadFailNum&&(b="已成功上传"+c.successNum+"张照片至XX相册，"+c.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>')):(c=q.getStats(),b="共"+i+"张（"+a.formatSize(j)+"），已上传"+c.successNum+"张",c.uploadFailNum&&(b+="，失败"+c.uploadFailNum+"张")),e.html(b)}function v(a){var e;if(a!==n){switch(f.removeClass("state-"+n),f.addClass("state-"+a),n=a){case"pedding":g.removeClass("element-invisible"),c.hide(),d.addClass("element-invisible"),q.refresh();break;case"ready":g.addClass("element-invisible"),$("#filePicker2").removeClass("element-invisible"),c.show(),d.removeClass("element-invisible"),q.refresh();break;case"uploading":$("#filePicker2").addClass("element-invisible"),h.show(),f.text("暂停上传");break;case"paused":h.show(),f.text("继续上传");break;case"confirm":if(h.hide(),f.text("开始上传").addClass("disabled"),e=q.getStats(),e.successNum&&!e.uploadFailNum)return v("finish"),void 0;break;case"finish":e=q.getStats(),e.successNum?alert("上传成功"):(n="done",location.reload())}u()}}var q,b=$("#uploader"),c=$('<ul class="filelist"></ul>').appendTo(b.find(".queueList")),d=b.find(".statusBar"),e=d.find(".info"),f=b.find(".uploadBtn"),g=b.find(".placeholder"),h=d.find(".progress").hide(),i=0,j=0,k=window.devicePixelRatio||1,l=110*k,m=110*k,n="pedding",o={},p=function(){var a=document.createElement("p").style,b="transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a;return a=null,b}();q=a.create({pick:{id:"#filePicker",label:"点击选择图片"},dnd:"#dndArea",paste:"#uploader",swf:"../../dist/Uploader.swf",chunked:!0,sendAsBinary:!0,server:"../../server/fileupload.php",fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800}),q.addButton({id:"#filePicker2",label:"继续添加"}),q.onUploadProgress=function(a,b){var c=$("#"+a.id),d=c.find(".progress span");d.css("width",100*b+"%"),o[a.id][1]=b,t()},q.onFileQueued=function(a){i++,j+=a.size,1===i&&(g.addClass("element-invisible"),d.show()),r(a),v("ready"),t()},q.onFileDequeued=function(a){i--,j-=a.size,i||v("pedding"),s(a),t()},q.on("all",function(a){switch(a){case"uploadFinished":v("confirm");break;case"startUpload":v("uploading");break;case"stopUpload":v("paused")}}),q.onError=function(a){alert("Eroor: "+a)},f.on("click",function(){return $(this).hasClass("disabled")?!1:("ready"===n?q.upload():"paused"===n?q.upload():"uploading"===n&&q.stop(),void 0)}),e.on("click",".retry",function(){q.retry()}),e.on("click",".ignore",function(){alert("todo")}),f.addClass("state-"+n),t()})});